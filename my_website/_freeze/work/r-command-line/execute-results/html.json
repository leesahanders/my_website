{
  "hash": "2f9e50f9c57da25f1d2f74ffed62adfb",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Command line / bash and R\" \ndescription: \"Experiments in running command line from R\"\nauthor: \"Lisa\"\ndate: \"2022-09-20\"\nformat:\n  html:\n    code-fold: true\n    code-summary: \"Show the code\"\neditor: source\ntoc: true\nimage: \"img/\"\ndraft: false\nfreeze: true\nfilters:\n   - lightbox\nlightbox: auto\ncategories:\n  - code\n---\n\n\n## Purpose\n\nHave you ever needed to run linux / mac / or windows commands from an R script? Do you have workflows where you have to create data files in R, pass to another system for processing, and then back into R for final visualization? \n\nOne of the best things about the R ecosystem is the massive spread of packages and capability that have already been developed, including for running operating system commands already at your fingertips. \n\nWarning: With great power comes great responsibility. While the commands listed in this document are safe to run it's always a good idea to double check what a system command actually does prior to running it, otherwise you could end up one of the examples [here](https://en.wikipedia.org/wiki/List_of_security_hacking_incidents). \n\n## Including Bash\n\nRMarkdown supports bash, sh and awk (depending on the hosting operating system). \n\nFor example: \n\n```bash\npwd\n```\n\nYou could also run something a little bit more complex: \n\n```bash\ncurrent_date=$(date)\necho \"Today is $current_date\"\n```\n\nNotes from [this resource](https://bookdown.org/yihui/rmarkdown-cookbook/eng-bash.html): \n\n - Running bash within rmarkdown will ignore profile files like ~/.bash_profile and ~/.bash_login, in which you may have defined command aliases or modified environment variables like the PATH variable. If you want these profile files to be executed just like when you use the terminal, you may pass the argument -l to bash via engine.opts, e.g.,\n\n```bash\n#bash, engine.opts='-l'\necho $PATH\n```\n\n - If you want to enable the -l argument globally for all bash chunks, you may set it in the global chunk option in the beginning of your document:`knitr::opts_chunk$set(engine.opts = list(bash = \"-l\"))`\n\n - You can also pass other arguments to bash by providing them as a character vector to the chunk option engine.opts.\n\n\n## System commands within R \n\nNote from [this resource](https://bookdown.org/yihui/rmarkdown-cookbook/eng-bash.html): Please note that bash is invoked with the R function system2(). \n\n```r\n# list all files and directories\nsystem2(command = \"ls\")\n```\n\nWe can use this to save a system output into our R workspace for later processing: \n\n```r\nvar <- system2(\"whoami\", stdout = TRUE, stderr = TRUE)\n\nprint(var)\n```\n\nYou can also use `input=` for commands that will have a response from the system that needs a response, like logging in where you supply a username and then it prompts you for a password. \n\n```r\nsystem('sudo -kS ls',input=readline(\"Enter your password: \"))\n```\n\n\n## Multi-line system commands in R\n\nThere is a good discussion on nuances of using system commands within R in [this stackoverflow post](https://stackoverflow.com/questions/37860616/unable-to-get-r-language-system2-command-result). \n\nsystem and system2 functions are designed for simple commands, as evidenced by the separation of the command word and command arguments into separate function arguments. However that can be subverted using shell metacharacters to run more complex statements. \n\n```r\nsystem('echo a b; echo c d');\n\nsystem2('echo',c('a','b; echo c d'));\n```\n\nAt this point in the complexity it is probably worth considering writing the commands you want to run as a [bin bash script](https://phoenixnap.com/kb/write-bash-script) which is then called by R to run from system. \n\n```r\nbash_script <- \"#!/bin/bash\n# A simple Bash script\necho pwd\necho ls\necho Done!\"\n\nwriteLines(bash_script, \"bash_script.sh\")\n\nsystem('chmod +x bash_script.sh')\n\nsystem2('./bash_script.sh', stdout = TRUE, stderr = TRUE)\n```\n\nWe could also use the built in [terminal in the Rstudio IDE](https://support.rstudio.com/hc/en-us/articles/115010737148-Using-the-RStudio-Terminal-in-the-RStudio-IDE) to write the .sh file (using vim, saving with escape/ctrl/cmd-c and :w, closing with escape/ctrl/cmd-c and typing :q). The permissions will need to be changed with `chmod +x demo.sh`. That file can then be run with `./demo.sh`.\n\n## Responding to Bash commands from R \n\nThere is a good example in [stackoverflow here](https://stackoverflow.com/questions/32239069/invoke-a-system-command-and-pipe-a-variable-as-an-argument). \n\nIn some cases it is useful to run a command and then be able to add an additional input. For example when signing in to a server being able to respond with a password, or to provide a yes to a prompt when installing a package. The input arg to system2 will accomplish this. \n\n`input: if a character vector is supplied, this is copied one string per line to a temporary file, and the standard input of ‘command’ is redirected to the file.`\n\n```r\nfoo = c(\"foo\", \"bar\")\nresult = system2(\"cat\", input = foo, stdout = TRUE)\n\nresult\n```\n\n## Mixing R and bash operations \n\nLet's save a file to disk using R: \n\n```r\n#my_data <-  data.frame(\"fruits\" = c(\"Mango\",\"Orange\",\"Grape\",\"Guava\",\"Apple\"))\n\nmy_data <- \"Mango, Orange, Grape, Guava, Apple\"\n\nwrite.table(my_data, file = \"my_data.txt\", sep = \"\", row.names = FALSE)\n\nread.delim(file = \"my_data.txt\")\n```\n\nLet's run a multi-line bash command and see the output: \n\n```bash\ncount_words=`wc -w my_data.txt`\necho \"Total words in my_data.txt is $count_words\"\n```\n\nWe could also run a bin bash script with commands so we can pass the output back into R for further processing: \n\n```r\nbash_script2 <- \"#!/bin/bash\n# A simple Bash script\nsed 's/a//g' my_data.txt\"\n\nwriteLines(bash_script2, \"bash_script2.sh\")\n\nsystem('chmod +x bash_script2.sh')\n\nmy_data2 <- system2('./bash_script2.sh', stdout = TRUE, stderr = TRUE)\n```\n\n[Some behavior](https://stackoverflow.com/questions/24257271/r-using-wait-false-in-system-with-multiline-commands) is reported that when running bash scripts in R with system using the wait argument (when used for running async with R) will only wait for the last line to complete. Solutions are discussed in that article. \n\n\n## Session memory from R and Python (bash commands)\n\nThere are several different ways to access this information, with the challenge coming in that depending on the command we can get host level information, system, rsession, kubernetes session, and different units (B vs iB vs bits). \n\nThe below are various functions and approaches for determining a robust approach that most closely matches what is available via the RStudio IDE and the [Workbench Admin Dashboard](https://colorado.rstudio.com/rstudio/admin/sessions). \n\nNotes: \n\n - Units: 1 MiB = 1,048,576 bytes, where mebibyte is MiB. \n - Default session has 2048 MB -> ~2 GB\n\n### From R: \n\nWhen inside kubernetes (similarly with docker containers) in order to get the session size we need to pull from inside the cgroups. \n\n\nAll of the options: \n\n```r\nsystem(\"cat /sys/fs/cgroup/memory/memory.stat\")\n```\n\nView the total memory with: \n\n```r\n# Total memory in session\ntotal = system(\"cat /sys/fs/cgroup/memory/memory.limit_in_bytes\", intern=T)\n\ntotal_rounded = (((as.numeric(total)/1024)/1024)/1024) # This is GiB\n\nprint(total_rounded)\n```\n\n\nView the used memory with: \n\n```r\n# Used memory \nused = system(\"cat /sys/fs/cgroup/memory/memory.usage_in_bytes\", intern=T)\n\nused_rounded = (((as.numeric(used)/1024)/1024)/1024) # This is GiB\n\nprint(used_rounded)\n```\n\nWe can then calculate the remaining memory with: \n\n```r\nremains <- as.numeric(total) - as.numeric(used) # this is in Bytes\n\nremains_rounded = (((remains/1024)/1024)/1024)\n\nprint(remains_rounded) # This is GiB\n```\n\n\nUnfortunately the below approaches all use the hosting container, rather than the session container (IE getting 32GB for the total size rather than the 2GB specified). \n\n```r\nsystem(\"free -t\")\n```\n\nFree isn't aware it is inside a container, it is giving memory of the parent server: \n\n```r\nsystem(\"free --mega\")\n```\n\nRunning top also reports something different, with 32 as the total amount of memory (showing the parent). \n\n```r\nsystem(\"top\")\n```\n\nWe can also use the \"garbage collector\", but note that this only gives us the used memory and not the total available. \n\n```r\ngc(verbose=TRUE)\n```\nBringing these approaches together we can use the function created by this [stackoverflow post](https://stackoverflow.com/questions/46690665/complete-r-session-size) which parses /proc/meminfo on linux as described in [this stackoverflow post](https://stackoverflow.com/questions/6457290/how-to-check-the-amount-of-ram/6457769#6457769). \n\n```r\ngetAvailMem <- function(format = TRUE) {\n\n  gc()\n\n  if (Sys.info()[[\"sysname\"]] == \"Windows\") {\n    memfree <- 1024^2 * (utils::memory.limit() - utils::memory.size())\n  } else {\n    # http://stackoverflow.com/a/6457769/6103040\n    memfree <- 1024 * as.numeric(\n      system(\"awk '/MemFree/ {print $2}' /proc/meminfo\", intern = TRUE))\n  }\n\n  `if`(format, format(structure(memfree, class = \"object_size\"),\n                      units = \"auto\"), memfree)\n}\n\ngetAvailMem()\n```\n\nOr directly parsing meminfo, per [this reference](https://www.faqcode4u.com/faq/44038/how-to-check-the-amount-of-ram-in-r): \n\n```r\n# 1024 * as.numeric(system(\"grep MemFree /proc/meminfo\"))\nsystem(\"grep MemFree /proc/meminfo\")\n```\n\nTotal amount of memory in kB that the OS thinks is available: \n\n```r\n# 1024 * as.numeric(system(\"grep MemFree /proc/meminfo\"))\nsystem(\"grep MemTotal /proc/meminfo\")\n```\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmemfree <- as.numeric(system(\"awk '/MemFree/ {print $2}' /proc/meminfo\", intern=TRUE))\nmemfree\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 2748548\n```\n\n\n:::\n:::\n\n\n\nAn alternative is the [memuse package](https://cran.r-project.org/web/packages/memuse/index.html) with [git here](https://github.com/shinra-dev/memuse): \n\n```r\nlibrary(memuse)\n# memuse::Sys.meminfo()\n# memuse::Sys.swapinfo() \nmemuse::Sys.procmem(gcFirst = FALSE) # Our current size, matches the R Memory Usage Report. By setting gcFirst = FALSE we are not calling garbage collection prior to getting memory. \n# memuse::Sys.cachesize()\n# memuse::Sys.cachelinesize()\n\n# Expectations: \n#2076 MiB is expected total, 0.2721055 GB\n#1640 MiB remaining\n# 1 MiB = 1,048,576 bytes\n\n```\n\nUnfortunately it is reporting the parent container again: \n\n```r\nmemuse::Sys.meminfo(compact.free = FALSE)\n```\n\n\nWe can also try using [lobstr](https://lobstr.r-lib.org/): \n\n```r\nlibrary(lobstr)\n\nlobstr::mem_used()\n```\n\n\n```r\nusage <- function() {\n    m1 <- sum(gc(FALSE)[, \"(Mb)\"])\n    m2 <- as.double(system(paste(\"ps -p\", Sys.getpid(), \"-o pmem=\"), intern = TRUE))\n    c(`gc (MiB)` = m1, `ps (%)` = m2)\n}\nusage()\n```\n\n\n### From Python (using reticulate but would also work from another IDE, for example Jupyter): \n\n```r\nlibrary(reticulate)\n```\n\nNote this approach is using free, which shows the hosting container's memory, but the same approach as used in R above using cgroups can be applied. \n\n\n```python\nimport os\nos.system(\"free\")\n```\n\n## Too Long Didn't Read (TLDR)\n\nTLDR: Read [the excellently written r-bloggers post here](https://www.r-bloggers.com/2021/09/how-to-use-system-commands-in-your-r-script-or-package/). \n\nCommands to reference: \n\n - [system](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/system)\n - [system2](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/system2)\n - [commandArgs](https://stat.ethz.ch/R-manual/R-devel/library/base/html/commandArgs.html)\n - [shell](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/system)\n\nOther references: \n\n - https://www.r-bloggers.com/2021/09/how-to-use-system-commands-in-your-r-script-or-package/ \n - https://bash-intro.rsquaredacademy.com/r-command-line.html\n - https://bookdown.org/yihui/rmarkdown-cookbook/eng-bash.html\n - https://wetlandsandr.wordpress.com/2018/09/15/integrating-bash-and-r/\n\n### Resources\n\nLearn more about memory profiling: [http://adv-r.had.co.nz/memory.html#memory-profiling](http://adv-r.had.co.nz/memory.html#memory-profiling)\n\nWithin a RStudio/Posit products from the admin side there are some additional tools that can be handy: \n\n - [https://support.rstudio.com/hc/en-us/articles/360046919174](https://support.rstudio.com/hc/en-us/articles/360046919174)\n - [https://support.rstudio.com/hc/en-us/articles/360044800273](https://support.rstudio.com/hc/en-us/articles/360044800273)\n - [https://support.rstudio.com/hc/en-us/articles/1500005616261-Understanding-Memory-Usage-in-the-RStudio-IDE](https://support.rstudio.com/hc/en-us/articles/1500005616261-Understanding-Memory-Usage-in-the-RStudio-IDE)\n - [http://adv-r.had.co.nz/memory.html](http://adv-r.had.co.nz/memory.html)\n - [https://stackoverflow.com/questions/46690665/complete-r-session-size](https://stackoverflow.com/questions/46690665/complete-r-session-size)\n - Read about what ubuntu load is: [https://www.brendangregg.com/blog/2017-08-08/linux-load-averages.html](https://www.brendangregg.com/blog/2017-08-08/linux-load-averages.html)\n - [https://stackoverflow.com/questions/53333858/how-to-clean-up-r-memory-without-the-need-to-restart-r-session](https://stackoverflow.com/questions/53333858/how-to-clean-up-r-memory-without-the-need-to-restart-r-session)\n - [https://github.com/rstudio/rstudio/issues/9353](https://github.com/rstudio/rstudio/issues/9353)\n - [https://engineering.linkedin.com/blog/2016/08/don_t-let-linux-control-groups-uncontrolled](https://engineering.linkedin.com/blog/2016/08/don_t-let-linux-control-groups-uncontrolled)\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}