<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.23">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Lisa">
<meta name="dcterms.date" content="2025-05-07">
<meta name="description" content="I was confused, so I went through this with a friend and wrote up the steps">

<title>Using SAML and SCIM with EntraID with Posit Team – Lisa Anders - questionable.quarto</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-1fe81d0376b2c50856e68e651e390326.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark-6f6599830d51be977da3b6af758f8eff.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-1fe81d0376b2c50856e68e651e390326.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-e91c052eb570edf2d22681b9d732e88e.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark-41747d4fbeb8042c449695184b3e5aec.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="../site_libs/bootstrap/bootstrap-e91c052eb570edf2d22681b9d732e88e.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title"><span class="icon-upper">LISA ANDERS</span><span class="icon-sep"></span><span class="icon-lower">questionable.quarto</span></span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-stuff" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-fa-database" role="img">
</i> 
 <span class="menu-text">Stuff</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-stuff">    
        <li>
    <a class="dropdown-item" href="https://questionable.quarto.pub/posts/">
 <span class="dropdown-text">Blog / Projects</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lists.html">
 <span class="dropdown-text">Lists</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../presentations.html">
 <span class="dropdown-text">Presentations</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://questionable.quarto.pub/recipes/">
 <span class="dropdown-text">Recipes</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../work.html">
 <span class="dropdown-text">Technical writeups</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../site_map.html"> 
<span class="menu-text">Site Map</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/leesahanders/my_website"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Using SAML and SCIM with EntraID with Posit Team</h1>
                  <div>
        <div class="description">
          I was confused, so I went through this with a friend and wrote up the steps
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">code</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Lisa </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 7, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#configuring-azure-entraid-for-saml-auth-in-workbench-with-scim-for-user-provisioning-and-connect-no-user-provisioning-ui-access-only" id="toc-configuring-azure-entraid-for-saml-auth-in-workbench-with-scim-for-user-provisioning-and-connect-no-user-provisioning-ui-access-only" class="nav-link active" data-scroll-target="#configuring-azure-entraid-for-saml-auth-in-workbench-with-scim-for-user-provisioning-and-connect-no-user-provisioning-ui-access-only">Configuring Azure EntraID for SAML Auth in Workbench (with SCIM for user provisioning) and Connect (no user provisioning, UI access only)</a>
  <ul class="collapse">
  <li><a href="#networking-requirements" id="toc-networking-requirements" class="nav-link" data-scroll-target="#networking-requirements">Networking requirements</a></li>
  <li><a href="#system-dependencies" id="toc-system-dependencies" class="nav-link" data-scroll-target="#system-dependencies">System dependencies</a></li>
  <li><a href="#ssl-requirements" id="toc-ssl-requirements" class="nav-link" data-scroll-target="#ssl-requirements">SSL requirements</a>
  <ul class="collapse">
  <li><a href="#workbench" id="toc-workbench" class="nav-link" data-scroll-target="#workbench">Workbench</a></li>
  <li><a href="#connect" id="toc-connect" class="nav-link" data-scroll-target="#connect">Connect</a></li>
  </ul></li>
  <li><a href="#create-the-azure-applications" id="toc-create-the-azure-applications" class="nav-link" data-scroll-target="#create-the-azure-applications">Create the Azure applications</a>
  <ul class="collapse">
  <li><a href="#create-the-azure-application-for-workbench" id="toc-create-the-azure-application-for-workbench" class="nav-link" data-scroll-target="#create-the-azure-application-for-workbench">Create the Azure application for Workbench</a></li>
  <li><a href="#configure-workbench-with-saml" id="toc-configure-workbench-with-saml" class="nav-link" data-scroll-target="#configure-workbench-with-saml">Configure Workbench with SAML</a></li>
  <li><a href="#configure-scim-provisioning-for-workbench" id="toc-configure-scim-provisioning-for-workbench" class="nav-link" data-scroll-target="#configure-scim-provisioning-for-workbench">Configure SCIM Provisioning for Workbench</a></li>
  <li><a href="#configuring-the-scim-provisioning-token-for-workbench" id="toc-configuring-the-scim-provisioning-token-for-workbench" class="nav-link" data-scroll-target="#configuring-the-scim-provisioning-token-for-workbench">Configuring the SCIM Provisioning token for Workbench</a></li>
  <li><a href="#create-the-azure-application-for-connect" id="toc-create-the-azure-application-for-connect" class="nav-link" data-scroll-target="#create-the-azure-application-for-connect">Create the Azure application for Connect</a></li>
  <li><a href="#configure-connect-with-saml" id="toc-configure-connect-with-saml" class="nav-link" data-scroll-target="#configure-connect-with-saml">Configure Connect with SAML</a></li>
  </ul></li>
  <li><a href="#restart" id="toc-restart" class="nav-link" data-scroll-target="#restart">Restart</a>
  <ul class="collapse">
  <li><a href="#workbench-1" id="toc-workbench-1" class="nav-link" data-scroll-target="#workbench-1">Workbench</a></li>
  <li><a href="#connect-1" id="toc-connect-1" class="nav-link" data-scroll-target="#connect-1">Connect</a></li>
  </ul></li>
  <li><a href="#assertions" id="toc-assertions" class="nav-link" data-scroll-target="#assertions">Assertions</a></li>
  <li><a href="#troubleshooting" id="toc-troubleshooting" class="nav-link" data-scroll-target="#troubleshooting">Troubleshooting</a></li>
  <li><a href="#but-what-about-proxies" id="toc-but-what-about-proxies" class="nav-link" data-scroll-target="#but-what-about-proxies">But what about proxies?</a>
  <ul class="collapse">
  <li><a href="#workbench-2" id="toc-workbench-2" class="nav-link" data-scroll-target="#workbench-2">Workbench</a></li>
  <li><a href="#connect-2" id="toc-connect-2" class="nav-link" data-scroll-target="#connect-2">Connect</a></li>
  </ul></li>
  <li><a href="#what-happens-when-users-leave-the-organization" id="toc-what-happens-when-users-leave-the-organization" class="nav-link" data-scroll-target="#what-happens-when-users-leave-the-organization">What happens when users leave the organization?</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">






<section id="configuring-azure-entraid-for-saml-auth-in-workbench-with-scim-for-user-provisioning-and-connect-no-user-provisioning-ui-access-only" class="level1">
<h1>Configuring Azure EntraID for SAML Auth in Workbench (with SCIM for user provisioning) and Connect (no user provisioning, UI access only)</h1>
<p>To configure Microsoft Entra ID for SAML, both the software address and an additional path, if being used, must be known. If there is not an additional path being served from then omit that from the below instructions. In addition Azure requires a secure connection, and so a valid SSL certificate (cannot be self-signed) is needed.</p>
<section id="networking-requirements" class="level2">
<h2 class="anchored" data-anchor-id="networking-requirements">Networking requirements</h2>
<p>Relevant cheat sheet in docs: <a href="https://docs.posit.co/getting-started/networking.html">https://docs.posit.co/getting-started/networking.html</a></p>
<p>Getting info from azure is on a push basis for SCIM provisioning, so we need connectivity open on port 443 via the express route or however so there is access. In order for authentication via SAML and Azure to work these ports need to be enabled:</p>
<ul>
<li>443 (for https)</li>
</ul>
<p>Networking access is needed between the Connect and Workbench servers and the Azure service.</p>
<p>Connect will also need web sockets enabled. Will be needed for each of the redirects (as detailed in the lower section).</p>
</section>
<section id="system-dependencies" class="level2">
<h2 class="anchored" data-anchor-id="system-dependencies">System dependencies</h2>
<p>On Rhel9:</p>
<pre><code>yum install -y oddjob oddjob-mkhomedir</code></pre>
</section>
<section id="ssl-requirements" class="level2">
<h2 class="anchored" data-anchor-id="ssl-requirements">SSL requirements</h2>
<p>Azure restricts to only using https addresses, not http, for doing redirects and authentication via API. A SSL certificate must be installed on each server. This SSL cert must be recognizable by Azure, meaning that it can’t be an internal CA.</p>
<p>Does the cert need to be installed on the server, or does installing it for the prox work? It just needs the “front door” address to have HTTPS, if running with an App gateway, then you only need SSL on that load balancer/proxy.</p>
<section id="workbench" class="level3">
<h3 class="anchored" data-anchor-id="workbench">Workbench</h3>
<pre><code>openssl req -new -key $URL.key -out $URL.csr -config $URL.cnf
openssl genrsa -out $URL.key 2048</code></pre>
<pre><code>#-----------------------------------------------------------------------------------------#
# HTTPS Configuration Section
#
# The certificate key should be owned by rstudio and have perms: sudo chmod 600 /var/certs/rstudio.key
# Unfortunately at this time, RStudio doesn't support a passphrase on the SSL cert.
ssl-enabled=1
ssl-certificate-key=/path/to/key/posit.key
ssl-certificate=/path/to/certificate/posit.crt
ssl-protocols=TLSv1.2 TLSv1.3</code></pre>
<pre><code>openssl x509 -noout -modulus -in /etc/rstudio/fullchain.cer | openssl md5
openssl rsa -noout -modulus -in /etc/rstudio/fullchain.key | openssl md5</code></pre>
</section>
<section id="connect" class="level3">
<h3 class="anchored" data-anchor-id="connect">Connect</h3>
<pre><code>nano root.crt ← paste contents of root certificate 
sudo cp root.crt /etc/pki/ca-trust/source/anchors/
sudo update-ca-trust
trust list | grep -i &lt;name&gt;</code></pre>
<pre><code>[HTTPS]
; https://docs.posit.co/connect/admin/appendix/configuration/#HTTPS
; RStudio Connect will listen on this network address for HTTPS connections.
Listen = :443
;Path to a PEM encoded TLS certificate file. If the certificate is signed by a certificate authority,
;the certificate file should be the concatenation of the server's certificate followed by the CA's certificate
Certificate =  /path/to/certificate/connect.crt
;Path to a PEM encoded private key file corresponding to the certificate specified with
Key = /path/to/key/connect.key
; Force HTTPS
; https://docs.posit.co/connect/admin/security/#guaranteeing-https
;Permanent = True
MinimumTLS = 1.2</code></pre>
</section>
</section>
<section id="create-the-azure-applications" class="level2">
<h2 class="anchored" data-anchor-id="create-the-azure-applications">Create the Azure applications</h2>
<p>Two separate applications inside Azure need to be created to support authentication on Connect and Workbench (different reply url assertion consumer service url’s).</p>
<ul>
<li><p>Through the marketplace: Manage → enterprise apps → add a new one → search for rstudio</p></li>
<li><p><strong>Rstudio-server-pro SAML authentication</strong> - is what you want for Workbench (refer to <a href="https://docs.posit.co/ide/server-pro/authenticating_users/integrated_providers/azure_ad_saml.html">here</a>)</p></li>
<li><p><strong>Rstudio Connect SAML authentication</strong> - is what you want for Connect (refer to <a href="https://docs.posit.co/ide/server-pro/authenticating_users/integrated_providers/azure_ad_saml.html">here</a>)</p></li>
</ul>
<p>See the <a href="https://learn.microsoft.com/en-us/entra/identity/app-provisioning/customize-application-attributes">Customize user provisioning attribute mappings tutorial</a> in Microsoft’s documentation for more information on adding custom user attributes in Microsoft Entra ID.</p>
<section id="create-the-azure-application-for-workbench" class="level3">
<h3 class="anchored" data-anchor-id="create-the-azure-application-for-workbench">Create the Azure application for Workbench</h3>
<p>Refer to <a href="https://docs.posit.co/ide/server-pro/authenticating_users/integrated_providers/azure_ad_saml.html">here</a></p>
<p>For the URL’s if there is an additional path that Workbench is being served from then it should be added in the <code>&lt;path&gt;</code> field, otherwise that can be omitted. For example, the URL would be&nbsp;<code>https://&lt;RSW-SERVER&gt;/saml/metadataif</code> there isn’t an additional path.&nbsp;</p>
<p>In the&nbsp;Identifier (Entity ID)&nbsp;section, click&nbsp;Add identifier&nbsp;and in the&nbsp;Enter an identifier&nbsp;text box, type a URL using the following pattern: <code>https://&lt;RSW-SERVER&gt;/&lt;PATH&gt;/saml/metadata.</code></p>
<p>In the&nbsp;Reply URL (Assertion Consumer Server URL)&nbsp;section, click&nbsp;Add reply URL&nbsp;and type the URL using the following pattern: <code>https://&lt;RSW-SERVER&gt;/&lt;PATH&gt;/saml/acs.</code></p>
</section>
<section id="configure-workbench-with-saml" class="level3">
<h3 class="anchored" data-anchor-id="configure-workbench-with-saml">Configure Workbench with SAML</h3>
<p>Relevant page in docs: <a href="https://docs.posit.co/ide/server-pro/authenticating_users/saml_sso.html">https://docs.posit.co/ide/server-pro/authenticating_users/saml_sso.html</a> and <a href="https://docs.posit.co/ide/server-pro/authenticating_users/integrated_providers/azure_ad_saml.html">https://docs.posit.co/ide/server-pro/authenticating_users/integrated_providers/azure_ad_saml.html</a></p>
<p>Enable SAML auth:</p>
<pre><code>#/etc/rstudio/rserver.conf
auth-saml=1</code></pre>
<p>Complete the SAML section in the config to match the user attributes from EntraID:</p>
<pre><code>#/etc/rstudio/rserver.conf
auth-saml=1
auth-saml-metadata-url=&lt;federation-metadata-URI&gt;
auth-saml-sp-name-id-format=emailaddress
auth-saml-sp-attribute-username=NameID
auth-saml-sp-base-uri=&lt;RStudio-Server-URI&gt;
auth-saml-idp-post-binding=1</code></pre>
<p>Create the auth profile:</p>
<pre><code>sudo authselect create-profile pwb --base-on=minimal</code></pre>
<p>Edit the /etc/authselect/custom/pwb/nsswitch.conf file and add the pwb entry:</p>
<pre><code>#/etc/authselect/custom/pwb/nsswitch.conf
passwd:     files {if "with-altfiles":altfiles }systemd pwb {exclude if "with-custom-passwd"}
group:      files {if "with-altfiles":altfiles }systemd pwb {exclude if "with-custom-group"}
shadow:     files pwb                                       {exclude if "with-custom-shadow"}</code></pre>
<p>Enable the profile:</p>
<pre><code>authselect select custom/pwb --with-mkhomedir --force</code></pre>
<p>Note: At this time the docs aren’t accurate and say to run <code>sudo authselect select pwb --with-mkhomedir</code> instead of <code>authselect select custom/pwb --with-mkhomedir --force</code></p>
<p>Make sure the odd job service is active:</p>
<pre><code>systemctl enable --now oddjobd.service</code></pre>
<p>Prevent NSCD from caching information:</p>
<pre><code>vi /etc/nscd.conf
enable-cache passwd no
enable-cache group no
sudo systemctl restart nscd
ps -ef | grep nsc</code></pre>
</section>
<section id="configure-scim-provisioning-for-workbench" class="level3">
<h3 class="anchored" data-anchor-id="configure-scim-provisioning-for-workbench">Configure SCIM Provisioning for Workbench</h3>
<p>Relevant page in docs: <a href="https://docs.posit.co/ide/server-pro/user_provisioning/azure.html">https://docs.posit.co/ide/server-pro/user_provisioning/azure.html</a></p>
<p>Complete the user provisioning section in the config to match the user attributes from EntraID (modify the user-provisioning-start-uidas needed, might not matter and can be left off) :</p>
<pre><code>#/etc/rstudio/rserver.conf
user-provisioning-enabled=1
user-provisioning-start-uid=2000</code></pre>
</section>
<section id="configuring-the-scim-provisioning-token-for-workbench" class="level3">
<h3 class="anchored" data-anchor-id="configuring-the-scim-provisioning-token-for-workbench">Configuring the SCIM Provisioning token for Workbench</h3>
<p>Relevant page in docs: <a href="https://docs.posit.co/ide/server-pro/user_provisioning/managing_tokens.html">https://docs.posit.co/ide/server-pro/user_provisioning/managing_tokens.html</a></p>
<p>For SCIM provisioning&nbsp;and the token, I believe you will also need user provisioning turned on. You can do this with:&nbsp;</p>
<pre><code>#rserver.conf
user-provisioning-enabled=1</code></pre>
<p>Create a token:</p>
<pre><code>sudo rstudio-server user-service generate-token "My Token"</code></pre>
<p>Input the token through the Azure profile.</p>
<p>Provision a user by having a user log all the way in to Workbench.</p>
<p>Test it from command line:</p>
<pre><code>/usr/lib/rstudio-server/bin/pamtester --verbose rstudio &lt;user&gt; authenticate acct_mgmt setcred open_session close_session</code></pre>
</section>
<section id="create-the-azure-application-for-connect" class="level3">
<h3 class="anchored" data-anchor-id="create-the-azure-application-for-connect">Create the Azure application for Connect</h3>
<p>Refer to <a href="https://docs.posit.co/ide/server-pro/authenticating_users/integrated_providers/azure_ad_saml.html">here</a></p>
</section>
<section id="configure-connect-with-saml" class="level3">
<h3 class="anchored" data-anchor-id="configure-connect-with-saml">Configure Connect with SAML</h3>
<p>Relevant page in docs: <a href="https://docs.posit.co/connect/admin/authentication/saml-based/entra-id-saml/">https://docs.posit.co/connect/admin/authentication/saml-based/entra-id-saml/</a></p>
<pre><code>#; /etc/rstudio-connect/rstudio-connect.gcfg

[Server]
Address = https://posit.company.com

[Authentication]
Provider = "saml"

[SAML]
IdPMetaDataURL = "https://login.microsoftonline.com/{tenantid}/federationmetadata/2007-06/federationmetadata.xml?appid={appid}"
IdPAttributeProfile = azure
; Enable this for a better user experience, unless
; managing a large number of groups is a concern:
;GroupsAutoProvision = true
; When troubleshooting a SAML problem, more verbose logging
; is produced by uncommenting the following line:
;Logging = true</code></pre>
<p>EntraID limits group membership to 150. If a user is a member of more than 150 groups than their group list will be concatenated, potentially missing important ones that are needed inside Connect.</p>
<p>Register on first login can be disabled with:</p>
<pre><code>#; /etc/rstudio-connect/rstudio-connect.gcfg
[SAML]
RegisterOnFirstLogin = false</code></pre>
<p>In that case, users need to be created via the Connect API: <a href="https://docs.posit.co/connect/api/#post-/v1/users">https://docs.posit.co/connect/api/#post-/v1/users</a></p>
<pre><code>#!/bin/bash

API_KEY="your api key"

DATA='{
  "email": "john_doe@posit.co",
  "first_name": "John",
  "last_name": "Doe",
  "password": "",
  "unique_id": "string",
  "user_must_set_password": false,
  "user_role": "viewer",
  "username": "john_doe"
}'

curl --silent --show-error -L --max-redirs 0 --fail \
    -X POST \
    -H "Authorization: Key ${API_KEY}" \
    --data-raw "${DATA}" \
    "https://connect.example.com/__api__/v1/users"</code></pre>
</section>
</section>
<section id="restart" class="level2">
<h2 class="anchored" data-anchor-id="restart">Restart</h2>
<section id="workbench-1" class="level3">
<h3 class="anchored" data-anchor-id="workbench-1">Workbench</h3>
<pre><code>sudo rstudio-server restart</code></pre>
</section>
<section id="connect-1" class="level3">
<h3 class="anchored" data-anchor-id="connect-1">Connect</h3>
<pre><code>sudo systemctl restart rstudio-connect</code></pre>
</section>
</section>
<section id="assertions" class="level2">
<h2 class="anchored" data-anchor-id="assertions">Assertions</h2>
<p>This image shows the needed assertions on the left, and the assertions associated with a test user on the right. Test user is failing to log into Workbench due to missing assertions. Once the last name and email were added logins were successful.</p>
<p>The list of assertions expected by Connect are documented <a href="https://docs.posit.co/connect/admin/authentication/saml-based/entra-id-saml/#the-azure-profile">here</a>:</p>
<pre><code>; /etc/rstudio-connect/rstudio-connect.gcfg
[SAML]
UniqueIdAttribute = NameID
NameIDFormat = persistent
UsernameAttribute = http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name
FirstNameAttribute = http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname
LastNameAttribute = http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname
EmailAttribute = http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress
GroupsAttribute = http://schemas.microsoft.com/ws/2008/06/identity/claims/groups</code></pre>
</section>
<section id="troubleshooting" class="level2">
<h2 class="anchored" data-anchor-id="troubleshooting">Troubleshooting</h2>
<p>If no useful messages are showing in the Connect or Workbench logs, it could be an issue with the auth provider configuration, URL’s, or network access. Turning on debug logging may help with errors outside of the auth provider configuration.</p>
</section>
<section id="but-what-about-proxies" class="level2">
<h2 class="anchored" data-anchor-id="but-what-about-proxies">But what about proxies?</h2>
<p>Example endpoint for app: whole host name including proxy information scim v2, for example <a href="https://workbench-hostname">https://workbench-hostname</a>&gt;/scim/v2. Example in the case they are running with a proxy at root wb: <a href="https://%3CWorkbench%20URL%3E/%3CPATH%3E/scim/v2">https://<workbench url="">/<path>/scim/v2</path></workbench></a></p>
<section id="workbench-2" class="level3">
<h3 class="anchored" data-anchor-id="workbench-2">Workbench</h3>
<p>Relevant page in docs: <a href="https://docs.posit.co/ide/server-pro/access_and_security/running_with_a_proxy.html">https://docs.posit.co/ide/server-pro/access_and_security/running_with_a_proxy.html</a> and <a href="https://docs.posit.co/ide/server-pro/authenticating_users/saml_sso.html#proxy-considerations">https://docs.posit.co/ide/server-pro/authenticating_users/saml_sso.html#proxy-considerations</a></p>
<p>The reverse proxy should be correctly forwarding the connection and the certificate on the proxy is publicly trusted. Workbench needs to know it’s running on HTTPS however. Generally that’s done by the proxy forwarding the X-Forward-Proto header as https.</p>
<p>We have an example here showing setting the X-Forward-Proto&nbsp;headers, an example without SSL is described as “If the Nginx proxy is using SSL and Workbench has ssl-enabled=0” :&nbsp;<a href="https://docs.posit.co/ide/server-pro/access_and_security/running_with_a_proxy.html#nginx-configuration">https://docs.posit.co/ide/server-pro/access_and_security/running_with_a_proxy.html#nginx-configuration</a> &nbsp;</p>
<p>The documentation default is:&nbsp;</p>
<pre><code>#/etc/rstudio/rserver.conf
www-root-path=/rstudio</code></pre>
<p>However, in the proxy configuration you are actually being hosted on /wb not rstudio so I believe it should look like:&nbsp;</p>
<pre><code>#/etc/rstudio/rserver.conf
www-root-path=/wb</code></pre>
<p>I believe in your URL to your tenant that it will need the /wb prefix as well, IE instead of &lt;https://<workbench url="">/scim/v2&gt; it should be&nbsp;&lt;https://<workbench url="">/<path>/scim/v2&gt;</path></workbench></workbench></p>
<p>The path prefix will need to be propagated throughout, what comes to mind is also the ACS URL configuration in the Enterprise App which is currently pointing to&nbsp;&lt;https://<workbench url="">/saml/acs&gt;but should be &lt;https://<workbench url="">/<path>/saml/acs&gt;</path></workbench></workbench></p>
</section>
<section id="connect-2" class="level3">
<h3 class="anchored" data-anchor-id="connect-2">Connect</h3>
<p>Relevant page in docs: <a href="https://docs.posit.co/connect/admin/proxy/">https://docs.posit.co/connect/admin/proxy/</a> and <a href="https://docs.posit.co/connect/admin/authentication/saml-based/entra-id-saml/index.html#authenticating-with-saml-using-multiple-network-aliases">https://docs.posit.co/connect/admin/authentication/saml-based/entra-id-saml/index.html#authenticating-with-saml-using-multiple-network-aliases</a></p>
<p>Connect needs web sockets to be enabled.</p>
<pre><code># Support proxying of web-socket connections
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}</code></pre>
</section>
</section>
<section id="what-happens-when-users-leave-the-organization" class="level2">
<h2 class="anchored" data-anchor-id="what-happens-when-users-leave-the-organization">What happens when users leave the organization?</h2>
<p>When users leave the organization, or removed from the application, than their account will be locked. This is the advantage of configuring it with SCIM / integrating directly with the authentication provider. Any home directories, deployed content, etc will remain on the server and can be cleaned up using any internal policies.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/questionable\.quarto\.pub\/blog");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>