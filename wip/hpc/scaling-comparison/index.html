<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="NA">

<title>Lisa Anders - questionable.quarto - Scaling Posit Team</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../../../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../../../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../../../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title"><span class="icon-upper">LISA ANDERS</span><span class="icon-sep"></span><span class="icon-lower">questionable.quarto</span></span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-stuff" role="button" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-fa-database" role="img">
</i> 
 <span class="menu-text">Stuff</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-stuff">    
        <li>
    <a class="dropdown-item" href="https://questionable.quarto.pub/posts/">
 <span class="dropdown-text">Blog / Projects</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../lists.html">
 <span class="dropdown-text">Lists</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../presentations.html">
 <span class="dropdown-text">Presentations</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://questionable.quarto.pub/recipes/">
 <span class="dropdown-text">Recipes</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../work.html">
 <span class="dropdown-text">Technical writeups</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../site_map.html"> 
<span class="menu-text">Site Map</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/leesahanders/my_website"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Scaling Posit Team</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="original" class="level2">
<h2 class="anchored" data-anchor-id="original">ORIGINAL</h2>
<p>The Posit products can be scaled to leverage additional compute and High Performance Compute (HPC) resources.</p>
<p>Scaling your Posit applications to leverage HPC and more powerful compute resources can provide various benefits such as computation scaleability, resource isolation, ease of management, reproducibility and resource allocation flexibility. This article will try to provide some additional context and rationale why you might want to implement the products in this way.</p>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>Option 1:</p>
<table class="table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Scaling Method</th>
<th>Scaling Technology</th>
<th>Recommended use case</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>HPC</strong></td>
<td>- Kubernetes<br>- Slurm</td>
<td>Allows for a shared compute pool that can be divided among users, with options for auto-scaling. Requires an admin to build and maintain an HPC environment. Through the use of containers with Docker or Singularity, multiple otherwise conflicting underlying environments can be available to users.</td>
</tr>
<tr class="even">
<td><strong>External compute resource</strong></td>
<td>-Custom architectures<br>- Spark</td>
<td>Launch jobs from the products to an external compute resource, returning results on completion. Often used when server isolation is important to prevent resource contention. Typically requires more configuration by the users.</td>
</tr>
<tr class="odd">
<td><strong>Managed environment</strong></td>
<td>- AWS Sagemaker<br>- Azureml<br>- Databricks<br>- GCP Workstations<br>- Snowflake</td>
<td>Decreases admin overhead by using a managed service. Forced to use the vendor’s architecture and configuration choices, which might not always be ideal. Particularly useful as an offloading strategy for larger than average user jobs in order to minimize the compute needed for a self-maintained instance.</td>
</tr>
</tbody>
</table>
</section>
<section id="when-is-scaling-needed" class="level2">
<h2 class="anchored" data-anchor-id="when-is-scaling-needed">When is scaling needed?</h2>
<p>Before going down the rabbit hole of exploring the options that fall under HPC or external compute integrations, consider the issues being encountered and if a simpler solution would address them:</p>
<ul>
<li>Adding an additional compute node to become load balanced / high availability</li>
<li>Implementing linux rules to address system crashes</li>
<li>Design a failover / backup plan so that worst-case-scenario outages are fast to recover from</li>
<li>Add staging servers so that infrastructure changes are tested before being rolled out to production</li>
</ul>
</section>
<section id="why-high-performance-computing-hpc" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="why-high-performance-computing-hpc">Why High-Performance Computing (HPC)?</h2>
<p>High-performance computing is sometimes used as a generic term to describe any system architecture that gives the ability to process data and perform complex calculations at high speeds. However, High-Performance Computing (HPC) more accurately is a specific type of distributed computing in which computer clusters are used to solve advanced computation problems.</p>
<p>In an HPC environment, jobs are broken down into smaller pieces which are then farmed out across the cluster and calculated in a distributed fashion. Commonly containers will be used as a part of the HPC environment to define the environment for that particular job. This type of distributed computation is needed for working on extremely large data sets that would otherwise not lend themselves to being analyzed in more traditional environments.</p>
<section id="kubernetes" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="kubernetes">Kubernetes</h3>
<p>Kubernetes is an open-source container orchestration system for automating software deployment, scaling, and management. Originally designed by Google, it is now an Open Source project maintained by the Cloud Native Computing Foundation.</p>
<p>In a Kubernetes environment, applications run in containers (usually Docker) which are spun up and down based on rules and settings determined ahead of time. These pre-determined rules and settings represent “states” and the Kubernetes control system takes care of allocating resources as-needed to ensure that the system stays in a desired state at all times. This type of system is also known as a “declarative system”, where the state is defined by the user, but the system itself implements the commands needed to achieve that state. This is different from a traditional “imperative system” in which the user is responsible for giving specific commands needed for the system to be running in a certain way.</p>
<p>Posit Workbench integrates with the Job Launcher to allow you to run your JupyterLab, Jupyter Notebook, RStudio Pro, and VS Code Sessions within your Kubernetes cluster. Furthermore, users can submit standalone Workbench jobs to the Kubernetes cluster to run computationally expensive R or Python scripts separate from their active session.</p>
<p>Posit Connect integrates with the Job Launcher to allow your different content types to run within your Kubernetes cluster. Publishers and admins can select the runtime environment, enabling different OS level configurations to be provided and easily accessed to support different content needs that may otherwise be incompatible.</p>
<p>Posit Package Manager can be fully hosted within the Kubernetes environment, easing maintenance by providing the same configuration options as what is available for Workbench and Connect.</p>
<section id="basic-kubernetes-components" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="basic-kubernetes-components">Basic Kubernetes Components</h4>
<p>A basic understanding of Kubernetes components is helpful before delving into the recomended implementation patterns for running Posit applications in K8s. A basic overview of pertinent terms is provided below. We recommended that you have a working knowledge of Kubernetes and Helm when installing our products in Kubernetes.</p>
<div class="column-page-inset-right">
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
u1(User)
u2(User)
u3(User)
b1(Browser)
b2(Browser)
b3(Browser)
ingress(Ingress Controller &lt;br/&gt; nginx/nginx-ingress)
workbench(Workbench &lt;br/&gt; Launcher &lt;br/&gt; ghcr.io/rstudio/rstudio-workbench)
connect(Connect &lt;br/&gt; Launcher)
packagemanager(Package Manager)
rsession(RStudio Session &lt;br/&gt; docker.io/rstudio/r-session-complete)
jupyter(Jupyter Session &lt;br/&gt; ghcr.io/rstudio/py-session-complete)
vscode(VS Code Session &lt;br/&gt; ghcr.io/rstudio/py-session-complete)
job(Workbench Job &lt;br/&gt; docker.io/rstudio/r-session-complete)
qmd(Quarto&lt;br/&gt;ghcr.io/rstudio/content-base:r-40-py-3.8)
flask(Flask App&lt;br/&gt;ghcr.io/rstudio/content-base:py-3.8)
shiny(Shiny App&lt;br/&gt;ghcr.io/rstudio/content-base:r-4.0)
dash(Dash App&lt;br/&gt;ghcr.io/rstudio/content-base:py-3.8)
nfs(Shared Storage)
pg(Postgres)


u1---b1
u2---b2
u3---b3
b1---ingress
b2---ingress
b3---ingress

subgraph k8s [Kubernetes cluster]
    ingress---workbench
    ingress---connect
    ingress---packagemanager
    workbench---rsession
    workbench---jupyter
    workbench---vscode
    workbench---job
    connect---qmd
    connect---flask
    connect---shiny
    connect---dash
end

k8s-..-pg
k8s-..-nfs

classDef server fill:#FAEEE9,stroke:#ab4d26
classDef product fill:#447099,stroke:#213D4F,color:#F2F2F2
classDef session fill:#7494B1,color:#F2F2F2,stroke:#213D4F
classDef element fill:#C2C2C4,stroke:#213D4F
classDef req fill:#72994E,stroke:#1F4F4F

class k8s server
class workbench,connect,packagemanager product
class ingress,rsession,jupyter,vscode,job,qmd,flask,shiny,dash session
class u1,u2,u3,b1,b2,b3,lb element
class pg,nfs req
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div>
<section id="nodes" class="level5">
<h5 class="anchored" data-anchor-id="nodes">Nodes</h5>
<p>The smallest level of computing in Kubernetes is a Node. A node can be thought of as an individual VM or compute instance with its own set of CPU and RAM resources. Nodes are the smallest level of physical compute resource in a Kubernetes cluster and are where pods run.</p>
</section>
<section id="clusters" class="level5">
<h5 class="anchored" data-anchor-id="clusters">Clusters</h5>
<p>A cluster is a group of nodes which work together to form a larger, more flexible “machine” than a single node. Kubernetes manages the distribution of work across multiple nodes and when nodes are added or removed, work is shifted across the nodes, as necessary.</p>
</section>
<section id="pods" class="level5">
<h5 class="anchored" data-anchor-id="pods">Pods</h5>
<p>Pods are groups of one or more containers that share the same resources and local network, making it easy for different containers in the same pod to communicate with each other. Pods spin up and down as a unit, so for example, a pod might contain 2 or 3 separate containers, each running a specific component needed for a larger, cohesive application. The pod will spin up all of the containers as a unit, and shut them down as a unit when it is stopped. (Note that all of a pod’s containers will be running on the same node.)</p>
</section>
<section id="helm-charts" class="level5">
<h5 class="anchored" data-anchor-id="helm-charts">Helm Charts</h5>
<p>Helm charts package together YAML files and templates that contain all of the information needed to deploy a container to a Kubernetes cluster. This makes it possible to download a chart, customize it (if necessary) and deploy it to a cluster with a single command. Helm charts make container deployment more efficient, reliable, and repeatable.</p>
</section>
</section>
<section id="kubernetes-implementation-resources" class="level4">
<h4 class="anchored" data-anchor-id="kubernetes-implementation-resources">Kubernetes Implementation Resources</h4>
<p>In the recommended configuration, each Posit product is installed in a Kubernetes cluster using a Posit-maintained <a href="https://github.com/rstudio/helm/tree/main/">Helm chart</a>.</p>
<p>Want to explore the recommended implementation? Refer to <a href="../../architectures/posit-team/">Architectural Overview of Posit Team: Running Inside a Kubernetes Cluster</a></p>
<p><strong>Ready to get started with Workbench and Kubernetes?</strong> View the documentation for <a href="https://docs.posit.co/ide/server-pro/integration/launcher-kubernetes.html">Integrating Workbench with Kubernetes</a></p>
<p><strong>Want to use custom Docker images with Kubernetes?</strong> View the guide for <a href="https://support.posit.co/hc/en-us/articles/360019253393-Using-Docker-images-with-RStudio-Server-Pro-Launcher-and-Kubernetes">Using Docker images with Workbench, Launcher, and Kubernetes</a></p>
<p><strong>Want to learn more about Workbench and Kubernetes?</strong> Refer to the <a href="https://support.posit.co/hc/en-us/articles/360021328733-FAQ-for-RStudio-Server-Pro-with-Launcher-and-Kubernetes">FAQ for Workbench with Launcher and Kubernetes</a></p>
</section>
</section>
<section id="slurm" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="slurm">Slurm</h3>
<p>Slurm is an open-source cluster management and job scheduling system for Linux compute clusters. It promises highly scaleable cluster management where it manages compute allocation to users for interactive work, a framework for running and monitoring scheduled jobs, and by managing a queue of work. Slurm is particularly notable for its modular design with optional plugins that can be installed and configured. Such plugins can be used for a wide range of additional capability like job prioritization algorithms, optimized resource selection, accounting, and running Apptainer/Singularity/Docker containers as the session environment with the Slurm compute resources.</p>
<p>Posit Workbench integrates with the Slurm cluster using Job Launcher to allow you to run your JupyterLab, Jupyter Notebook, RStudio Pro, and VS Code Sessions. Furthermore, users can submit standalone Workbench jobs to your compute cluster(s) to run computationally expensive R or Python scripts. Workbench Jobs allow you to run scripts in new sessions independent of your current RStudio Pro or VS Code session. These jobs are helpful for executing long-running scripts such as training models or running multiple jobs simultaneously. This functionality can dramatically improve the productivity of data scientists and analysts since they can continue working in Workbench while jobs are running in the background.</p>
<p>While native Slurm job launcher with Connect isn’t currently developed, users can leverage the package <a href=""><code>clustermq</code></a>. Interested in learning more? Refer to <a href="../../../connections/connect-slurm/">Launching jobs from Connect to Slurm</a></p>
<section id="basic-slurm-components" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="basic-slurm-components">Basic Slurm Components</h4>
<p>A basic understanding of Slurm components is helpful before delving into the recomended implementation patterns. A basic overview of pertinent terms is provided below. We recommended that you have a working knowledge of Slurm when installing our products with an integration with Slurm.</p>
<div class="column-page-inset-right">
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
u1(User)
u2(User)
u3(User)
b1(Browser)
b2(Browser)
b3(Browser)
smn(Slurm Head Node)
workbench(Workbench)
rsession(RStudio Session)
jupyter(Jupyter Session)
vscode(VS Code Session)
job(Workbench Job)
launcher(Launcher)
nfs(Shared Storage)
pg(Postgres)
sj1(submits job)
sj2(submits job)

u1---b1
u2---b2
u3---b3
b1---workbench
b2---workbench
b3---workbench

subgraph hpc [HPC]

    subgraph box [ ]

        subgraph server [Submit Node]
            workbench---launcher
        end

    %%launcher -- submits job --- smn

    launcher --- sj1
    sj1 --- smn

    subgraph box2 [ ]

    subgraph main [Head Node]
        smn
    end

    smn--- sj2

    sj2---rsession
    sj2---jupyter
    sj2---vscode
    sj2---job


    subgraph cluster [Compute Node]
        rsession
        jupyter
        vscode
        job

    end
    end
    end

    server-.-pg

    server-.-nfs
    main-.-nfs
    cluster-.-nfs

end

classDef hpc fill:#eeeeee,stroke:#666666
classDef server fill:#FAEEE9,stroke:#ab4d26
classDef product fill:#7494B1,color:#F2F2F2,stroke:#213D4F
classDef session fill:#7494B1,color:#F2F2F2,stroke:#213D4F
classDef element fill:#C2C2C4,stroke:#213D4F
classDef req fill:#72994E,stroke:#1F4F4F
classDef note fill:#eeeeee,stroke:#333,stroke-width:0px,color:#fff,stroke-dasharray: 5 5
classDef box fill:#eeeeee,stroke:#eeeeee

class hpc hpc
class server,cluster,main server
class workbench,launcher,smn product
class rsession,jupyter,vscode,job session
class u1,u2,u3,b1,b2,b3,lb element
class pg,nfs req
class note,sj1,sj2 note
class box,box2 box
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div>
<section id="nodes-1" class="level5">
<h5 class="anchored" data-anchor-id="nodes-1">Nodes</h5>
<p>The smallest level of computing resource in an HPC cluster is a Node. A node can be thought of as an individual VM or compute instance with its own set of CPU and RAM resources.</p>
</section>
<section id="submit-node" class="level5">
<h5 class="anchored" data-anchor-id="submit-node">Submit Node</h5>
<p>Workbench acts as the Submit Node enabling users to run sessions and submit jobs via the SLURM Launcher against a SLURM cluster with arbitrary number of compute nodes of a given type. This Submit Node / Workbench Node can exist internal or external to the HPC environment.</p>
</section>
<section id="head-node" class="level5">
<h5 class="anchored" data-anchor-id="head-node">Head Node</h5>
<p>The Slurm Head Node allocates the appropriate computational resources to a request from the Workbench Submit Node according to the Slurm queue.</p>
</section>
<section id="compute-node" class="level5">
<h5 class="anchored" data-anchor-id="compute-node">Compute Node</h5>
<p>The compute node is within the HPC cluster where the requested user session or submitted jobs run. Session components will need to be accessible from the Slurm compute nodes (installed or mounted), or Singularity can be used as session containers.</p>
</section>
<section id="shared-storage" class="level5">
<h5 class="anchored" data-anchor-id="shared-storage">Shared Storage</h5>
<p>Users’ home directories must be stored on a shared file system (typically an NFS server), shared storage typically includes /home, /scratch, data folders, and session containers. Users must exist on both Workbench servers and the Slurm cluster node, for example by pointing to the same authentication provider.</p>
</section>
<section id="postgres-database" class="level5">
<h5 class="anchored" data-anchor-id="postgres-database">Postgres Database</h5>
<p>The use of an external PostgreSQL database server is necessary when using multiple Workbench servers.</p>
</section>
<section id="docker-apptainer-singularity" class="level5">
<h5 class="anchored" data-anchor-id="docker-apptainer-singularity">Docker / Apptainer / Singularity</h5>
<p>Launched sessions or jobs can optionally utilize reproduceable software environments via Docker or Apptainer / Singularity containers. These containers provide an additional level of isolation and the ability to have drastically different compute environments available for developers, for example different installed system dependencies or even different operating systems.</p>
</section>
</section>
<section id="slurm-implementation-resources" class="level4">
<h4 class="anchored" data-anchor-id="slurm-implementation-resources">Slurm Implementation Resources</h4>
<p>Ready to get started with Workbench and Slurm? Proceed to the documentation for <a href="https://docs.posit.co/rsw/integration/launcher-slurm/">Integrating Workbench with Slurm</a></p>
<p>Interested in Using Apptainer/Singularity? Refer to <a href="../../architectures/pwb/">Workbench with Slurm and Singularity</a></p>
<p>Want to explore the recommended implementation? Refer to <a href="../../launcher/singularity/">Architectural Overview of Posit Workbench in Slurm</a></p>
<p><strong>Ready to get started with Workbench and Slurm?</strong> Proceed to the documentation for <a href="https://docs.posit.co/ide/server-pro/integration/launcher-slurm.html">Integrating Workbench with Slurm</a></p>
<p><strong>Want to learn more about Workbench and Slurm?</strong> Refer to the <a href="https://support.posit.co/hc/en-us/articles/360035543713-FAQ-for-RStudio-Server-Pro-with-Launcher-and-Slurm">FAQ for Workbench with Launcher and Slurm</a></p>
<p><strong>Interested in Using Apptainer/Singularity?</strong> Refer to <a href="../../launcher/singularity/">Workbench with Slurm and Singularity</a></p>
</section>
</section>
</section>
<section id="external-compute-resource" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="external-compute-resource">External Compute Resource</h2>
<p>Instead of running the Posit software where sessions are launched from within the compute environment, external server(s) running the software can be configured to offload a job to a separate external compute resource and later return the result. This can be useful in organizations where there is an external compute resource that doesn’t support native integration, or for other reasons is required to have isolated server(s).</p>
<p>One challenge is to keep the connection “alive” while the receiving server waits for the results to return, otherwise the connection may prematurely terminate. This challenge has been eliminated with the Spark/Databricks integration, when using the supported packages and integration method.</p>
<section id="basic-configuration" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="basic-configuration">Basic Configuration</h4>
<p>A basic configuration is shown below for a Posit Product to integrate with an external compute resource.</p>
<div class="column-page-inset-right">
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
u1(User)
u2(User)
u3(User)
b1(Browser)
b2(Browser)
b3(Browser)

workbench(Workbench)
config1(Configuration/Authentication)

rsession(RStudio Session)
jupyter(Jupyter Session)
vscode(VS Code Session)
job1(Workbench Job)

connect(Connect)
config2(Configuration/Authentication)
job2(Connect Job)

mon(Monitoring)

u1---b1
u2---b2
u3---b3
b1---workbench
b2---connect
b3---connect

subgraph environment1
    workbench---config1
    config1---rsession
    config1---jupyter
    config1---vscode
end

subgraph environment2
    connect---config2
end

subgraph cluster [External Resource]
    rsession---job1
    jupyter---job1
    vscode---job1
    config2---job2
end


environment1-.-mon
environment2-.-mon
cluster-.-mon

classDef server fill:#FAEEE9,stroke:#ab4d26
classDef product fill:#447099,stroke:#213D4F,color:#F2F2F2
classDef session fill:#7494B1,color:#F2F2F2,stroke:#213D4F
classDef element fill:#C2C2C4,stroke:#213D4F
classDef req fill:#72994E,stroke:#1F4F4F

class server,cluster,environment1,environment2 server
class workbench,launcher,connect,config1,config2 product
class rsession,jupyter,vscode,job1,job2 session
class u1,u2,u3,b1,b2,b3,lb element
class pg,nfs,mon req
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div>
</section>
<section id="spark-databricks" class="level3">
<h3 class="anchored" data-anchor-id="spark-databricks">Spark / Databricks</h3>
<p>The Spark / Databricks integration has built-in support for connection maintenance through using the <code>sparklyr</code> or <code>pyspark</code> packages, eliminating the need for manual handling to be developed by users.</p>
<p><strong>Interested in integrating Workbench with Spark / Databricks?</strong> Refer to the implementation resources:</p>
<ul>
<li><a href="https://docs.posit.co/ide/server-pro/integration/databricks.html">Integrate Workbench with Databricks</a></li>
<li><a href="https://docs.posit.co/ide/server-pro/integration/sparklyr.html">Integrate Workbench with Spark and sparklyr</a></li>
<li><a href="https://docs.posit.co/ide/server-pro/integration/pyspark.html">Integrate Workbench and Jupyter with PySpark</a></li>
<li><a href="https://spark.posit.co/deployment/databricks-connect.html">Using <code>sparklyr</code> with Databricks</a></li>
</ul>
<p><strong>Interested in integrating Connect with Spark / Databricks?</strong> Refer to the blog article <a href="https://posit.co/blog/databricks-shiny-r-app/">From Databricks to Posit Connect</a>.</p>
</section>
</section>
<section id="managed-environments" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="managed-environments">Managed environments</h2>
<p>In these solutions, the administrative burden of provisioning and maintaining the HPC environment is being handled by the chosen vendor. This gives the advantage of running in a HPC environment, but without the downside of the additional labor. However, because these solutions are pre-configured that can mean being locked in to architecture choices that might not be ideal, that if self-managed could be adjusted.</p>
<p>These managed environments offerings are Workbench-only:</p>
<ul>
<li>AWS Sagemaker</li>
<li>Azureml</li>
<li>GCP Workstations</li>
<li>Snowflake</li>
</ul>
<p>Managed environments can be especially useful in organizations where there are “peaks” of computationally intensive jobs that are occasionally run and can be offloaded to a separate environment. Using this strategy, a “regular-use” Posit Team deployment can be the main environment and kept to a minimum scale, while the occasional jobs that need the larger compute are spun up on demand separately and then closed when finished.</p>
<section id="basic-configuration-1" class="level4 page-columns page-full">
<h4 class="anchored" data-anchor-id="basic-configuration-1">Basic Configuration</h4>
<p>A basic configuration is shown below for a Posit Product being accessed as a managed environment:</p>
<div class="column-page-inset-right">
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart LR
u1(User)
u2(User)
u3(User)
b1(Browser)
b2(Browser)
b3(Browser)

u1---b1
u2---b2
u3---b3
b1---workbench1
b2---workbench2
b3---workbench3

    subgraph domain["Managed Domain"]

        direction LR

        subgraph note["**Note**"]
            noteNote("Architecture not expanded in this diagram.\nDifferent vendor solutions have different key differences.\nRefer to vendor for specifics on desired solution.")
        end

        subgraph rstudioManaged["Managed Workbench"]

            subgraph workbenchEC2["Posit Workbench"]
                workbench1("Posit Workbench")
                workbench2("Posit Workbench")
                workbench3("Posit Workbench")
                launcher1("Launcher")
                launcher2("Launcher")
                launcher3("Launcher")
                workbench1---launcher1
                workbench2---launcher2
                workbench3---launcher3
            end

            subgraph ec2SpecA ["Session Compute Selection 1"]
                rstudioIdeSession1("Developer IDE Session #1")
            end

            subgraph ec2SpecB ["Session Compute Selection 2"]
                rstudioIdeSession2("Developer IDE Session #2")
            end

            subgraph ec2SpecC ["Session Compute Selection 3"]
                rstudioIdeSession3("Developer IDE Session #3")
            end

        end

        launcher1---rstudioIdeSession1
        launcher2---rstudioIdeSession2
        launcher3---rstudioIdeSession3

        nfs[["\n\nVendor Managed File System\n\n\n"]]

        workbenchEC2-.-nfs
        ec2SpecA-.-nfs
        ec2SpecB-.-nfs
        ec2SpecC-.-nfs

    end

    classDef ec2Class fill:#c6c7cc
    classDef server fill:#FAEEE9,stroke:#ab4d26
    classDef blackbox fill:#C2C2C4,stroke:#213D4F
    classDef product fill:#447099,stroke:#213D4F,color:#F2F2F2
    classDef session fill:#7494B1,color:#F2F2F2,stroke:#213D4F
    classDef note fill:#C2C2C4,stroke-width:0px
    classDef nfs fill:#72994E,stroke:#1F4F4F
    classDef element fill:#C2C2C4,stroke:#213D4F

    class workbenchEC2,ec2SpecA,ec2SpecB,ec2SpecC server
    class note,rstudioManaged blackbox
    class workbench,workbench1,workbench2,workbench3,launcher,launcher1,launcher2,launcher3 product
    class rstudioIdeSession1,rstudioIdeSession2,rstudioIdeSession3 session
    class noteNote note
    class nfs nfs
    class u1,u2,u3,b1,b2,b3,lb element

    style domain fill:#f6f6f7,stroke-dasharray: 5 5
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div>
</section>
<section id="posit-workbench-on-aws-sagemaker" class="level3">
<h3 class="anchored" data-anchor-id="posit-workbench-on-aws-sagemaker">Posit Workbench on AWS Sagemaker</h3>
<p>Posit on Amazon SageMaker is a fully managed solution for Workbench without a traditional installation. Interested in learning more about the underlying architecture? Refer to <a href="../../sagemaker/architecture/">Architecture for RStudio on SageMaker</a></p>
<p><strong>Interested in Workbench on AWS Sagemaker?</strong> You can learn how to initially setup and manage this in the&nbsp;<a href="https://docs.aws.amazon.com/sagemaker/latest/dg/rstudio.html">AWS documentation</a>. More details are available in the&nbsp;<a href="https://docs.posit.co/ide/server-pro/integration/aws-sagemaker.html">Posit Workbench Administration Guide</a>&nbsp;and the&nbsp;<a href="https://www.rstudio.com/blog/using-rstudio-on-amazon-sagemaker-faq/">Using RStudio on Amazon SageMaker: Questions from the Community</a>&nbsp;blog post.</p>
</section>
<section id="posit-workbench-on-azureml" class="level3">
<h3 class="anchored" data-anchor-id="posit-workbench-on-azureml">Posit Workbench on&nbsp;AzureML</h3>
<p><strong>Interested in Workbench on AzureML?</strong><a href="https://learn.microsoft.com/en-us/azure/machine-learning/how-to-create-manage-compute-instance?tabs=python#setup-posit-workbench-formerly-rstudio-workbench">How to activate your license and get started in Posit Workbench on&nbsp;AzureML</a></p>
</section>
<section id="posit-workbench-on-google-cloud-workstations" class="level3">
<h3 class="anchored" data-anchor-id="posit-workbench-on-google-cloud-workstations">Posit Workbench on Google Cloud Workstations</h3>
<p><strong>Interested in Workbench on Google Cloud Workstations?</strong> <a href="https://cloud.google.com/workstations/docs/develop-code-using-posit-workbench-rstudio#create_the_workstation_configuration">How to activate your license and get started in Posit Workbench on Google Cloud Workstations</a></p>
</section>
<section id="snowflake" class="level3">
<h3 class="anchored" data-anchor-id="snowflake">Snowflake</h3>
<p><strong>TODO</strong></p>
</section>
</section>
<section id="additional-considerations" class="level2">
<h2 class="anchored" data-anchor-id="additional-considerations">Additional Considerations</h2>
<section id="auto-scaling" class="level3">
<h3 class="anchored" data-anchor-id="auto-scaling">Auto-scaling</h3>
<p>Auto-scaling settings can be enabled to dynamically add more resources. In general, scaling up is trivial, scaling down is where things can go wrong and resources can be left hanging. Having a monitoring system in place can be critical with any system set to enable auto-scaling to insure that budgets don’t get exceeded.</p>
<p><strong>Want to learn more about Posit recommendations with auto-scaling?</strong> Refer to <a href="../../launcher/autoscaling/">Auto-Scaling with Workbench and Kubernetes</a></p>
</section>
<section id="containerization" class="level3">
<h3 class="anchored" data-anchor-id="containerization">Containerization</h3>
<p>Posit products are designed to be long-running. Containerization is entirely supported, however care should be taken to ensure that the needed directories and logs are able to persist. In general this means setting the container to be long running, an may additionally involve increasing time-out settings if the container ever crashes, so that any logging programs or license deactivations are able to complete.</p>
<p><strong>Want to learn more about Posit recommendations when running the products in containers?</strong> Refer to <a href="../../docker/">Running Posit Products in Containers</a></p>
</section>
<section id="leveraging-the-hpc-environment" class="level3">
<h3 class="anchored" data-anchor-id="leveraging-the-hpc-environment">Leveraging the HPC environment</h3>
<p>Users may be surprised to find that when they first start using the HPC environment that the performance of their code likely won’t drastically improve. This is because both R and Python are single threaded and won’t natively use parallelization to take advantage of the additional compute resources. Fortunately, there are many packages that have been developed by the open source community that can be used for dramatic performance improvement. For example:</p>
<ul>
<li><a href="https://mschubert.github.io/clustermq/"><code>clustermq</code></a></li>
<li><a href="https://future.batchtools.futureverse.org/"><code>batchtools</code></a></li>
<li><a href="https://wlandau.github.io/crew.cluster/"><code>crew.cluster</code></a></li>
<li><a href="https://future.futureverse.org/"><code>future</code></a></li>
<li><a href="https://purrr.tidyverse.org/"><code>purrr</code></a></li>
<li><a href="https://www.rdocumentation.org/packages/foreach/versions/1.5.2/topics/foreach"><code>foreach</code></a></li>
<li><a href="https://rdatatable.gitlab.io/data.table/reference/openmp-utils.html"><code>data.table</code></a></li>
<li><a href="https://cran.r-project.org/web/packages/crew/index.html"><code>crew</code></a>: facilitates compute backens, also known as crew controllers</li>
<li><a href="https://cran.r-project.org/web/packages/mirai/index.html"><code>mirai</code></a>: Uses the <a href="https://cran.r-project.org/web/packages/nanonext/index.html">nanonext</a> framework</li>
<li><a href="https://wlandau.github.io/crew.cluster/"><code>crew.cluster</code></a>: extension of <a href="https://github.com/shikokuchuo/mirai">mirai</a> crew package</li>
</ul>
<p>CRAN has a <a href="https://cran.r-project.org/web/views/HighPerformanceComputing.html">useful article</a> exploring the ecosystem of HPC packages. This is a very useful resource to explore for users considering optimizing their code in an environment that supports parallelization.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>